# config.yml
beats_version: "7.17.0"
elasticsearch_hosts:
  - "http://your-elasticsearch-host:9200"
kibana_host: "http://your-kibana-host:5601"


---
- name: Install Beats on Linux Hosts
  hosts: linux_hosts
  become: true
  vars_files:
    - config.yml

  tasks:
    - name: Install required dependencies for RHEL-based systems
      yum:
        name:
          - wget
          - curl
        state: present

    - name: Add Elastic GPG Key for RHEL-based systems
      rpm_key:
        state: present
        key: https://artifacts.elastic.co/GPG-KEY-elasticsearch

    - name: Add Elastic repository for RHEL-based systems
      copy:
        dest: /etc/yum.repos.d/elastic.repo
        content: |
          [elastic]
          name=Elastic repository for 7.x packages
          baseurl=https://artifacts.elastic.co/packages/7.x/yum
          gpgcheck=1
          gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
          enabled=1
          autorefresh=1
          type=rpm-md

    - name: Install Filebeat and Metricbeat using yum
      yum:
        name:
          - filebeat
          - metricbeat
        state: present

    - name: Configure Filebeat
      copy:
        dest: /etc/filebeat/filebeat.yml
        content: |
          filebeat.inputs:
            - type: log
              enabled: true
              paths:
                - /var/log/*.log

          output.elasticsearch:
            hosts: {{ elasticsearch_hosts }}
          setup.kibana:
            host: {{ kibana_host }}
      notify: restart filebeat

    - name: Configure Metricbeat
      copy:
        dest: /etc/metricbeat/metricbeat.yml
        content: |
          metricbeat.modules:
            - module: system
              metricsets:
                - cpu
                - memory
                - network
                - filesystem
              enabled: true
              period: 10s
              processes: ['.*']

          output.elasticsearch:
            hosts: {{ elasticsearch_hosts }}
          setup.kibana:
            host: {{ kibana_host }}
      notify: restart metricbeat

    - name: Enable and start Filebeat
      service:
        name: filebeat
        enabled: yes
        state: started

    - name: Enable and start Metricbeat
      service:
        name: metricbeat
        enabled: yes
        state: started

  handlers:
    - name: restart filebeat
      service:
        name: filebeat
        state: restarted

    - name: restart metricbeat
      service:
        name: metricbeat
        state: restarted
