---
- name: Check security tools installation and running state
  hosts: all
  gather_facts: no

  vars:
    security_services:
      - name: bigfix
        service_name: besclient
      - name: crowdstrike
        service_name: falcon-sensor
      - name: qualys
        service_name: qualys-cloud-agent
      - name: splunk
        service_name: splunkd
      - name: tanium
        service_name: taniumclient

tasks:
    - name: Gather service facts
      ansible.builtin.service_facts:

    - name: Aggregate service statuses
      ansible.builtin.set_fact:
        service_statuses: >-
          {{
            security_services
            | items2dict(key='name', value=lambda x: {
                'installed': (x.service_name in services),
                'state': (services[x.service_name].state
                          if x.service_name in services
                          else 'not installed')
              })
          }}

    - name: Show aggregated report
      ansible.builtin.debug:
        var: service_statuses
